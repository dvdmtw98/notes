---
title: Portable Executable Format
aliases:
  - PE Format
tags:
  - security
  - malware
  - forensics
date: 2026-01-27 22:04:40 +0530
updated: 2026-01-29 23:30:01 +0530
---

Format used to represent executables, object code, and DLLs on Windows.  
It stores the information required by the Windows loader to run the wrapped code.  

The PE file format contains a header followed by a series of sections.  
The header contains metadata about the file itself.  

The sections names can vary between compilers.  
The names can also be obfuscated to make the analysis difficult.  
The real name does not matter Windows uses other information in the header to determine how to use each section.  

#### PE File Section

The `.text` section contains the instructions that are executed by the CPU. Generally, this is the only section that will execute and should be the only section that contains code.  

The `.rdata` section normally contains the import and export functions. It stores all the read-only data used by the application. Sometimes can be split into `.idata` (Import Data) and `.edata` (Export Data).  

The `.data` section contains the programs globally accessible data. Local data is not stored anywhere in the PE file.  

The `.rsrc` section contains resources used by the executable that are not considered part of the executable (icons, images, menus, and strings). Strings can be stored in `.rsrc` or main program but is often found here for programs that support multiple languages.

![[pe-format-sections.png|600]]

#### Analyzing PE File Headers

**`IMAGE_DOS_HEADER`** and **`MS-DOS Stub Program`** are historical and does not provide any useful information. 
- DOS programs use the DOS MZ executable format. This header makes the file look like a 16-bit DOS executable.  
- The `e_magic` stores the magic bytes of the DOS header (`MZ`) and `e_lfanew` stores the offset to the real PE header. 
- The Stub program is a small executable that would show a message when the executable was run on a DOS system.

##### IMAGE_NT_HEADERS
Primary header structure that describes how the executable image should be loaded by the OS loader.  

The **`Signature`** is always the same (can be ignored). Also called Magic bytes set to values `0x50450000` (`PE\0\0` in ASCII).

**`IMAGE_FILE_HEADER`** contains basic information about the binary's layout and properties. It is also called COFF Header.  
- The Time Date Stamp file tells us the compile time of the program. Old compile time would indicate old malware which would be known by antivirus software.  
- All Delphi programs show the compile time as June 19, 1992. The compile time can also be easily faked by the malware author.

> [!INFO] What is Delphi?
> - Delphi is a well-established software development system that serves as both a programming language and an integrated development environment (IDE).
> - Delphi uses Object Pascal (Pascal with OOP features).

![[pe_image_file_header.png|600]]

> [!IMPORTANT] What is COFF?
> - Stands for Common Object File Format. 
> - It is a binary format that was designed to represent object files and executable files in Unix System V.
> - Has mostly been replaced ELF on Linux system.
> - Windows PE format is based on COFF. Windows embeds COFF structures inside PE.

**`IMAGE_OPTIONAL_HEADER`** contains runtime-relevant information (only optional for object files).  
- The subsystem description lists whether it's a GUI or console application. `IMAGE_SUBSYSTEM_WINDOWS_CUI` represent console programs. `IMAGE_SUBSYSTEM_WINDOWS_GUI` denote GUI applications. 
- Some less common subsystems like Native and Xbox are also found in this section.

> [!INFO] What is a Subsystem?
> It is the execution environment that the program expects the OS to provide.
> - Win32 subsystem provides Windows API for GUI apps.
> - Console subsystem provides basic text I/O.
> - Native subsystem used by code that runs below Win32 (drivers, system processes).
> - UEFI subsystem runs firmware code before the OS boots.

> [!IMPORTANT] What are Object Files?
> - They contain machine code that is generated by a source file.
> - Object files are intermediate files that are used as input by the linker.
> - They are not complete programs and do not have an entry point.
> - `.obj` and `.o` are examples of object files.
> - Object files do not have `Signature`, `IMAGE_OPTIONAL_HEADER`, `IMAGE_DOS_HEADER` and `MS-DOS Stub Program` sections are they are not executable.

##### IMAGE_SECTION_HEADER
These headers are used to describe each section of the PE file. Compiler creates and names the sections of the executable. User has very little control over the name. Should be consistent across executables.  

![[section_info_packed.png|350]]

- `Virtual Size` tells us how much space is allocated for a section during the loading process. The `Size of Raw Data` shows how big the section is on disk.  
- The value for these two fields should be equal (as size on disk and in memory should be the same). Small deviations are normal (occurs due to alignment in memory and on disk).  
- When the size in memory is larger than size on disk the program is likely to be packed (true especially for `.text` section). It is normal for the size of `.data` section to be different on disk and in memory.   

![[section_info_unpacked.png|350]]

#### Analyzing Resource Section

Resource Hacker can be used to view the resources that are present in `.rsrc`.  
- **Icon** section shows images that are used with the executable is in a file listing.
- The **menu** section stores the menus that are used throughout the program. 
- The **dialog** section shows all the dialog menus that are used by the executable.
- The **string table** section stores strings.
- The **version info** section stores copyright information.

> [!INFO] Malicious Behavior
> Malware and occasionally legitimate software stores embedded driver in this section. Before the program is run this embedded driver is extracted.
